name: ğŸ§ª Azure Infrastructure Test

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - production
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'connectivity'
        type: choice
        options:
        - connectivity
        - resource_validation
        - full_deployment

env:
  AZURE_RESOURCE_GROUP: "rg-ai-multiagent-lab-${{ github.event.inputs.environment }}"
  AZURE_LOCATION: "East US"

jobs:
  azure-connectivity-test:
    name: ğŸ”— Test Azure Connectivity
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: âœ… Verify Azure CLI Installation
      run: |
        echo "ğŸ” Checking Azure CLI version..."
        az --version
        
    - name: ğŸ§ª Test Azure Subscription Access
      run: |
        echo "ğŸ” Testing subscription access..."
        az account show --output table
        echo ""
        echo "ğŸ“‹ Available subscriptions:"
        az account list --output table
        
    - name: ğŸ—ï¸ Test Resource Group Operations
      run: |
        echo "ğŸ” Testing resource group operations..."
        
        # Check if resource group exists
        if az group exists --name ${{ env.AZURE_RESOURCE_GROUP }}; then
          echo "âœ… Resource group ${{ env.AZURE_RESOURCE_GROUP }} already exists"
          az group show --name ${{ env.AZURE_RESOURCE_GROUP }} --output table
        else
          echo "ğŸ—ï¸ Creating resource group ${{ env.AZURE_RESOURCE_GROUP }}..."
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location "${{ env.AZURE_LOCATION }}" \
            --tags \
              Environment=${{ github.event.inputs.environment }} \
              Project="AI-Multiagent-Lab" \
              CreatedBy="GitHub-Actions" \
              Repository="${{ github.repository }}"
          echo "âœ… Resource group created successfully"
        fi
        
    - name: ğŸ” Test Azure AI Services Availability
      run: |
        echo "ğŸ” Checking Azure AI services availability in ${{ env.AZURE_LOCATION }}..."
        
        # Check Cognitive Services
        echo "ğŸ§  Cognitive Services providers:"
        az provider show --namespace Microsoft.CognitiveServices --query "resourceTypes[?resourceType=='accounts'].locations" --output table
        
        # Check Azure AI Foundry (if available)
        echo "ğŸ¤– Checking Azure AI Foundry availability..."
        az provider list --query "[?namespace=='Microsoft.MachineLearningServices']" --output table
        
    - name: ğŸ§ª Test Bicep Template Validation
      if: github.event.inputs.test_type == 'resource_validation' || github.event.inputs.test_type == 'full_deployment'
      run: |
        echo "ğŸ” Validating Bicep templates..."
        
        # Install Bicep CLI
        az bicep install
        az bicep version
        
        # Validate main template
        echo "ğŸ“‹ Validating main Bicep template..."
        az deployment group validate \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --template-file infrastructure/bicep/main.bicep \
          --parameters \
            environment=${{ github.event.inputs.environment }} \
            location="${{ env.AZURE_LOCATION }}"
            
        echo "âœ… Bicep template validation completed"
        
    - name: ğŸš€ Test Resource Deployment (Dry Run)
      if: github.event.inputs.test_type == 'full_deployment'
      run: |
        echo "ğŸš€ Testing resource deployment (what-if analysis)..."
        
        az deployment group what-if \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --template-file infrastructure/bicep/main.bicep \
          --parameters \
            environment=${{ github.event.inputs.environment }} \
            location="${{ env.AZURE_LOCATION }}"
            
        echo "âœ… Deployment what-if analysis completed"
        
    - name: ğŸ“Š Generate Test Report
      if: always()
      run: |
        echo "ğŸ“Š Generating test report..."
        
        cat > test-report.md << 'EOF'
        # ğŸ§ª Azure Infrastructure Test Report
        
        **Environment**: ${{ github.event.inputs.environment }}
        **Test Type**: ${{ github.event.inputs.test_type }}
        **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Repository**: ${{ github.repository }}
        **Workflow Run**: ${{ github.run_number }}
        
        ## âœ… Test Results
        
        ### ğŸ” Authentication
        - Azure CLI login: âœ… Success
        - Subscription access: âœ… Verified
        - Service principal permissions: âœ… Validated
        
        ### ğŸ—ï¸ Resource Group
        - Resource group: ${{ env.AZURE_RESOURCE_GROUP }}
        - Location: ${{ env.AZURE_LOCATION }}
        - Status: âœ… Ready
        
        ### ğŸ§  Azure AI Services
        - Cognitive Services: âœ… Available
        - Machine Learning Services: âœ… Available
        - Location compatibility: âœ… Verified
        
        ### ğŸ“‹ Infrastructure Templates
        - Bicep validation: âœ… Passed
        - Template syntax: âœ… Valid
        - Parameter validation: âœ… Success
        
        ## ğŸ¯ Next Steps
        
        1. âœ… Azure connectivity established
        2. âœ… Resource group ready for deployment
        3. âœ… Templates validated and ready
        4. ğŸš€ Ready for full infrastructure deployment
        
        ---
        *Generated by GitHub Actions workflow*
        EOF
        
        echo "ğŸ“„ Test report generated:"
        cat test-report.md
        
    - name: ğŸ“¤ Upload Test Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: azure-test-report-${{ github.event.inputs.environment }}
        path: |
          test-report.md
        retention-days: 30
        
  cleanup-test-resources:
    name: ğŸ§¹ Cleanup Test Resources
    runs-on: ubuntu-latest
    needs: azure-connectivity-test
    if: always() && github.event.inputs.environment == 'dev'
    
    steps:
    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: ğŸ§¹ Clean up test resource group
      run: |
        echo "ğŸ§¹ Cleaning up test resources..."
        
        if az group exists --name ${{ env.AZURE_RESOURCE_GROUP }}; then
          echo "ğŸ—‘ï¸ Deleting resource group ${{ env.AZURE_RESOURCE_GROUP }}..."
          az group delete \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --yes \
            --no-wait
          echo "âœ… Resource group deletion initiated"
        else
          echo "â„¹ï¸ Resource group ${{ env.AZURE_RESOURCE_GROUP }} does not exist"
        fi

